#!/bin/bash

# post-merge hook for Next.js
# master/main ë¸Œëœì¹˜ì— merge ë°œìƒ ì‹œ ì „ì²´ í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰

BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [ "$BRANCH" = "master" ] || [ "$BRANCH" = "main" ]; then
    echo ""
    echo "============================================"
    echo "ğŸ”€ $BRANCH ë¸Œëœì¹˜ merge ê°ì§€!"
    echo "ğŸ§ª Next.js ì „ì²´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
    echo "============================================"
    echo ""
    
    # 1. Lint ê²€ì‚¬
    echo "ğŸ“‹ 1/4. Lint ê²€ì‚¬..."
    npm run lint
    if [ $? -ne 0 ]; then
        echo "âŒ Lint ê²€ì‚¬ ì‹¤íŒ¨!"
        exit 1
    fi
    echo "âœ… Lint í†µê³¼"
    echo ""
    
    # 2. TypeScript íƒ€ì… ì²´í¬
    echo "ğŸ“‹ 2/4. TypeScript íƒ€ì… ì²´í¬..."
    npx tsc --noEmit
    if [ $? -ne 0 ]; then
        echo "âŒ TypeScript íƒ€ì… ì—ëŸ¬!"
        exit 1
    fi
    echo "âœ… íƒ€ì… ì²´í¬ í†µê³¼"
    echo ""
    
    # 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    echo "ğŸ“‹ 3/4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
    npm test -- --passWithNoTests
    if [ $? -ne 0 ]; then
        echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
        exit 1
    fi
    echo "âœ… í…ŒìŠ¤íŠ¸ í†µê³¼"
    echo ""
    
    # 4. ë¹Œë“œ í…ŒìŠ¤íŠ¸
    echo "ğŸ“‹ 4/4. ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
        exit 1
    fi
    echo "âœ… ë¹Œë“œ ì„±ê³µ"
    echo ""
    
    echo "============================================"
    echo "âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼! ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    echo "============================================"
fi
